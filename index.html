<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMS & POS System</title>
    <meta name="theme-color" content="#3b82f6">
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
              primary: {
                50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd',
                400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8',
                800: '#1e40af', 900: '#1e3a8a', 950: '#172554',
              },
            }
          },
        },
      }
    </script>
    <script>
      // Initialize global log buffer for mobile debugging
      window.__PWA_LOGS__ = [];
      
      function pwaDebug(msg) {
        const timestamp = new Date().toLocaleTimeString();
        const logLine = `[${timestamp}] [PWA] ${msg}`;
        console.log(logLine);
        window.__PWA_LOGS__.push(logLine);
      }

      pwaDebug("Initializing PWA checks...");

      // Global variable to hold the prompt event
      window.deferredPrompt = null;

      window.addEventListener('beforeinstallprompt', (e) => {
        pwaDebug("'beforeinstallprompt' event FIRED. Browser allowing install.");
        // Prevent the mini-infobar from appearing on mobile
        e.preventDefault();
        // Stash the event so it can be triggered later.
        window.deferredPrompt = e;
        pwaDebug("Event stashed in window.deferredPrompt.");
        // Dispatch a custom event to notify React components
        window.dispatchEvent(new Event('deferred-prompt-ready'));
      });

      if ('serviceWorker' in navigator) {
        pwaDebug("Service Worker is supported.");
        
        // Check if controller is already active
        if (navigator.serviceWorker.controller) {
           pwaDebug("Service Worker is currently CONTROLLING the page. (Offline Ready should be true)");
        } else {
           pwaDebug("Service Worker is NOT controlling the page yet. (Offline Ready might be false until reload)");
        }

        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').then(registration => {
            pwaDebug('SW registered successfully with scope: ' + registration.scope);

            if (registration.installing) {
                 pwaDebug('SW is installing...');
            } else if (registration.waiting) {
                 pwaDebug('SW is waiting/installed.');
            } else if (registration.active) {
                 pwaDebug('SW is active.');
            }

            registration.onupdatefound = () => {
              const installingWorker = registration.installing;
              if (installingWorker == null) {
                return;
              }
              pwaDebug('SW update found, installing new worker...');

              installingWorker.onstatechange = () => {
                pwaDebug('SW state change: ' + installingWorker.state);
                if (installingWorker.state === 'installed') {
                  if (navigator.serviceWorker.controller) {
                    // New update available
                    pwaDebug('New content is available; please refresh.');
                  } else {
                    // Content is cached for offline use.
                    pwaDebug('Content is cached for offline use. (Ready for Offline)');
                  }
                }
              };
            };
          }).catch(registrationError => {
            pwaDebug('SW registration failed: ' + registrationError);
          });
        });
      } else {
          pwaDebug("Service Worker is NOT supported in this browser.");
      }
    </script>
    <style>
      @media print {
        body * {
          visibility: hidden;
        }
        .printable-area, .printable-area * {
          visibility: visible;
        }
        .printable-area {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          padding: 1rem;
        }
        .no-print {
            display: none !important;
        }
        .dark .printable-area {
          background-color: white !important;
          color: black !important;
        }
        .dark .printable-area * {
            color: black !important;
        }
      }
      
      /* Global styles to remove focus outlines from charts and tap highlights */
      .recharts-wrapper, .recharts-surface, .recharts-layer {
        outline: none !important;
      }
      
      /* Remove default focus outline system-wide, relying on Tailwind's ring utilities for accessibility */
      *:focus {
        outline: none !important;
      }

      * {
        -webkit-tap-highlight-color: transparent;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "recharts": "https://aistudiocdn.com/recharts@^3.4.1",
    "react-dom": "https://aistudiocdn.com/react-dom@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.29.1",
    "dexie": "https://unpkg.com/dexie@3.2.4/dist/dexie.mjs",
    "dexie-react-hooks": "https://unpkg.com/dexie-react-hooks@1.1.7/dist/dexie-react-hooks.mjs",
    "@vitejs/plugin-react": "https://aistudiocdn.com/@vitejs/plugin-react@^5.1.1",
    "vite": "https://aistudiocdn.com/vite@^7.2.6"
  }
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
  <body class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800">
    <div id="root"></div>
    <script type="module" src="/index.tsx"></script>
  </body>
</html>